<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tﾃｭtulos Financeiros</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        h2 { color: #333; }
        .filtros { margin-bottom: 20px; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filtros label { margin-right: 5px; }
        .filtros input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .filtros button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .filtros button:hover { background-color: #0056b3; }
        #btn-limpar { background-color: #6c757d; }
        #btn-limpar:hover { background-color: #5a6268; }
        
        table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f0f0f0; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        #loading { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

    <h2>Consulta de Tﾃｭtulos Financeiros</h2>

    <div class="filtros">
        <label for="empresa">Empresa:</label>
        <input type="text" id="empresa" placeholder="Cﾃｳdigo da Empresa">

        <label for="parceiro">Parceiro:</label>
        <input type="text" id="parceiro" placeholder="Cﾃｳdigo do Parceiro">

        <button id="btn-buscar">Buscar</button>
        <button id="btn-limpar">Limpar e Ver Todos</button>
    </div>

    <p id="loading">Carregando dados...</p>
    <table>
        <thead>
            <tr>
                <th>NUFIN</th>
                <th>Nﾃｺm. Nota</th>
                <th>Empresa (Fantasia)</th>
                <th>Parceiro (Nome)</th>
                <th>Natureza (Descriﾃｧﾃ｣o)</th>
            </tr>
        </thead>
        <tbody id="tabela-dados">
            </tbody>
    </table>

    <script>
        // Pegando os elementos do HTML
        const inputEmpresa = document.getElementById('empresa');
        const inputParceiro = document.getElementById('parceiro');
        const btnBuscar = document.getElementById('btn-buscar');
        const btnLimpar = document.getElementById('btn-limpar');
        const tbody = document.getElementById('tabela-dados');
        const loading = document.getElementById('loading');

        // FUNﾃﾃグ PARA BUSCAR OS DADOS NA API (no seu server.js)
        async function buscarDados() {
            // Pega os valores dos inputs
            const emp = inputEmpresa.value;
            const parc = inputParceiro.value;

            // Prepara a URL
            // Isso cria a url: /financeiro?empresa=...&parceiro=...
            const url = new URL('/financeiro', window.location.origin);
            if (emp) {
                url.searchParams.set('empresa', emp);
            }
            if (parc) {
                url.searchParams.set('parceiro', parc);
            }

            console.log("Chamando API em:", url.toString());
            loading.textContent = "Buscando dados..."; // Mostra o "Carregando"
            tbody.innerHTML = ""; // Limpa a tabela antiga

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // A resposta do Sankhya vem dentro dessa estrutura
                const linhas = data.responseBody.entities.entity;
                
                // Chama a funﾃｧﾃ｣o para desenhar a tabela
                renderizarTabela(linhas);

            } catch (error) {
                console.error("Falha ao buscar dados:", error);
                loading.textContent = "";
                tbody.innerHTML = `<tr><td colspan="5">Erro ao buscar dados: ${error.message}</td></tr>`;
            }
        }

        // FUNﾃﾃグ PARA DESENHAR A TABELA com os dados
        function renderizarTabela(linhas) {
            if (!linhas || linhas.length === 0) {
                loading.textContent = "";
                tbody.innerHTML = '<tr><td colspan="5">Nenhum dado encontrado.</td></tr>';
                return;
            }

            // Limpa o "carregando" e a tabela
            loading.textContent = "";
            tbody.innerHTML = "";

            // Cria uma linha (<tr>) para cada item
            linhas.forEach(item => {
                // O 'item' ﾃｩ o objeto que vem da API
                // Ex: { NUFIN: {$: "123"}, Empresa: { NOMEFANTASIA: {$: "Nome"} }, ... }
                
                // Usamos "?.$" (optional chaining) para evitar erros se um campo vier nulo
                // 噫 AJUSTE: Lendo os campos genﾃｩricos f0, f3, f4, f5, f6
                const nufin = item.f0?.$ || '---';      // f0 ﾃｩ o NUFIN
                const numnota = item.f3?.$ || '---';    // f3 ﾃｩ o NUMNOTA
                const empresa = item.f4?.$ || '---';    // f4 ﾃｩ o Empresa.NOMEFANTASIA
                const parceiro = item.f5?.$ || '---';   // f5 ﾃｩ o Parceiro.NOMEPARC
                const natureza = item.f6?.$ || '---';   // f6

                // Cria a linha HTML
                const tr = `
                    <tr>
                        <td>${nufin}</td>
                        <td>${numnota}</td>
                        <td>${empresa}</td>
                        <td>${parceiro}</td>
                        <td>${natureza}</td>
                        
                    </tr>
                `;
                
                // Adiciona a linha na tabela
                tbody.innerHTML += tr;
            });
        }

        // FUNﾃﾃグ PARA O BOTﾃグ "LIMPAR"
        function limparFiltros() {
            inputEmpresa.value = "";
            inputParceiro.value = "";
            buscarDados(); // Busca novamente (agora sem filtros)
        }

        // O QUE FAZER QUANDO OS BOTﾃ髭S Sﾃグ CLICADOS
        btnBuscar.addEventListener('click', buscarDados);
        btnLimpar.addEventListener('click', limparFiltros);

        // CARREGA OS DADOS INICIAIS (os 100 em aberto) assim que a pﾃ｡gina abre
        document.addEventListener('DOMContentLoaded', buscarDados);

    </script>
</body>
</html>